# Netskope and CA Certs

No solution found yet.

Observation: WSL HTTP interactions and certificates are influenced by the host
Windows system, in particular with effects from Netskope.

## Possible (Partial?) Solution 1

This doesn't fix the problem mentioned below, but perhaps it fixes other
(general) problems not yet observed.

* In WSL, link the Windows Netskope cert file in `/etc/ssl/certs/`:  
  `sudo ln -sf /mnt/c/ProgramData/netskope/stagent/data/nscacert.pem /etc/ssl/certs/nscacert.pem`

Edit: Now it seems that this path (`/mnt/c/...`) is not valid, so removed this
link. (But see solution 7.)

## Possible (Partial?) Solution 2

This doesn't fix the problem mentioned below, but perhaps it fixes other (Node
related) problems not yet observed.

* In WSL, edit the environment file, targetting Node.
  * Enter the file:  
    `sudo vim /etc/environment`
  * Add this line, below the line for the PATH:  
    `NODE_EXTRA_CA_CERTS="/mnt/c/ProgramData/netskope/stagent/data/nscacert.pem"`

Edit: Now it seems that this path (`/mnt/c/...`) is not valid, so removed this
line. (But see solution 7.)

## Possible (Partial?) Solution 3

This doesn't fix the problem mentioned below, but perhaps it fixes other
(general) problems not yet observed.

Generate copies of (apparently) all certificates in Windows. Copy them over into
the WSL Linux system (EG, into `~/dev/support/wsl2-netskope-windows-certs/`).
Link to them from the `/etc/ssl/certs/` folder.

EG, `sudo ln -s ~/dev/support/wsl2-netskope-windows-certs/* /etc/ssl/certs`

* <https://github.com/bayaro/windows-certs-2-wsl>
* Found via <https://github.com/microsoft/WSL/issues/3161>

Edit: This didn't work, but tried a variation. (See solution 4.)

## Possible (Partial?) Solution 4

Saw in file `/etc/ca-certificates.conf` that maybe I should place certs in
`/usr/share/ca-certificates/`, and so I deleted the links with the command below
but then I realized that the conf file is autogenerated and just handles cert
files of a particular type (`*.crt`, though apparently transforming the final
product into a `*.pem` file).  So maybe linking directly and to a location
outside of `/usr/share/ca-certificates/` is fine -- just not managed with
commands such as `update-ca-certificates`.  So I'll try it anyway.

* Delete links created previously:  
  `sudo find /etc/ssl/certs -type l -lname "$HOME/dev/support/wsl2-netskope-windows-certs/*" -exec rm {} \;`
* Reorganize folders, so the `wsl2-netskop-...` folder is placed deeper as
  `certs-from-windows` (see next step).
* Copy over files into the "proper" (maybe) location.  
  `sudo cp ~/dev/support/certs-wsl-issue/certs-from-windows/* /usr/share/ca-certificates/certs-from-windows/`
* Link certs.
  `sudo ln -s /usr/share/ca-certificates/certs-from-windows/* /etc/ssl/certs`

Reference:

* <https://www.cyberciti.biz/faq/update-ca-certificates-command-examples-in-linux-to-ssl-ca-certificates/>

## Possible (Partial?) Solution 5

Help from Shane Ryan. Shane gave me a couple pfx files with certificates.

* Extract key (using password from Shane).  
  `openssl pkcs12 -in root_cert.pfx -nocerts -out root_key.pem -nodes`  
  (but output file is empty)
* Extract cert (using password from Shane).  
  `openssl pkcs12 -in root_cert.pfx -nokeys -out root_cert.pem`  
  (and output file is not empty, good)
* Do the same as for `root_cert.pfx` for `intermediate_cert.pfx`.
* Move output files into an output folder (see next step).
* Copy over files into the "proper" (maybe) location.  
  `sudo cp ~/dev/support/certs-wsl-issue/certs-help-from-shane/output/root_cert.pem /usr/share/ca-certificates/certs-from-shane/`  
  `sudo cp ~/dev/support/certs-wsl-issue/certs-help-from-shane/output/intermediate.pem /usr/share/ca-certificates/certs-from-shane/`
* Link certs.
  `sudo ln -s /usr/share/ca-certificates/certs-from-shane/* /etc/ssl/certs`

References:

* Worked well enough, producing one contentful file and one empty file.
  <https://tecadmin.net/extract-private-key-and-certificate-files-from-pfx-file>
* Tried first but didn't work, producing two empty files.  
  Extracting key and cert:  
  <https://www.ibm.com/docs/en/arl/9.7?topic=certification-extracting-certificate-keys-from-pfx-file>

## Possible (Partial?) Solution 6

Separate out individual certs into their own clean files. As found on internet:

The .pem file format is used for storing cryptographic objects such as SSL
certificates and private keys. While it's possible to have additional content
like "Bag Attributes" and "issuer" in a .pem file, the convention for SSL
certificates is to only include the certificate itself. Including extra metadata
or attributes may cause issues when applications attempt to read or use the
certificate.

To ensure compatibility and avoid potential problems, it's best to keep the
certificate file clean, containing only the certificate data between the
specified boundaries. If you have additional metadata or attributes related to
the certificate, they are usually stored separately or within the application's
configuration.

* Remove previously-created links:  
  `sudo find /etc/ssl/certs -type l -lname "/usr/share/ca-certificates/certs-from-shane/*" -exec rm {} \;`
* Remove previously-copied files:  
  `sudo rm /usr/share/ca-certificates/certs-from-shane/*.pem`
* Copy the original pem files and edit them to be cleaned and separated. Got 5 files:  
  root_cert_1.pem  
  root_cert_2.pem  
  intermediate_cert_1.pem  
  intermediate_cert_2.pem  
  intermediate_cert_3.pem
* Copy over files into the "proper" (maybe) location.  
  `sudo cp ~/dev/support/certs-wsl-issue/certs-help-from-shane/output/separated-and-cleaned/*.pem /usr/share/ca-certificates/certs-from-shane`
* Link certs.
  `sudo ln -s /usr/share/ca-certificates/certs-from-shane/* /etc/ssl/certs`

## Possible (Partial?) Solution 7

Let's try a variation for solution 1 (and 2), akin to solution 6.

* Looks like the file isn't even there..  
  `ls /mnt/c/ProgramData/netskope/stagent/data/nscacert.pem`  
  (/bin/ls: cannot access '/mnt/c/ProgramData/netskope/stagent/data/nscacert.pem': No such file or directory)  
  `ls /mnt/c/`  
  (nothing)
* So look for it in Windows.  
  Windows Settings, search for certificates.. `certmgr`  
  Certificates - Current User > Intermediate Certification Authorities >  
  Certificates > `ca.pacificdental.goskope.com`
* Extract as `.p7b` file (since pfx is not available).  
  `netskope_cert.p7b`
* Copy into Linux machine.
* Extract certificate from p7b file.  
  best: `openssl pkcs7 -in netskope_cert.p7b -inform DER -print_certs -out netskope_cert.pem`  
  good: `openssl pkcs7 -inform der -in netskope_cert.p7b -out netskope_cert.cer`  
  bad: `openssl pkcs7 -print_certs -in certificate.p7b -out certificate.pem`  
  (last one didn't work, had an error:  
    unable to load PKCS7 object  
    140263235129984:error:0909006C:PEM routines:get_name:no start line:../crypto/pem/pem_lib.c:745:Expecting: PKCS7  
  )
* Copy the original pem file and edit it to be cleaned and separated. Got 2 files:  
  netskope_cert_1.pem  
  netskope_cert_2.pem
* Copy over files into the "proper" (maybe) location.  
  `sudo cp ~/dev/support/certs-wsl-issue/cert-for-netskope/output/separated-and-cleaned/*.pem /usr/share/ca-certificates/certs-from-windows-for-netskope`
* Link certs.
  `sudo ln -s /usr/share/ca-certificates/certs-from-windows-for-netskope/* /etc/ssl/certs`

Reference:

* <https://serverfault.com/questions/417140/convert-from-p7b-to-pem-via-openssl>
* <https://knowledge.digicert.com/solution/how-to-convert-pkcs-7-to-pem-certificate-format-using-openssl>

## Problem

I'm a remote developer, using a Windows machine with WSL (Linux in Windows,
"Windows Subsystem for Linux"). When I attempt to open VSCode from within WSL,
it automatically attempts to download and install a VSCode server for WSL, but
it fails due to a self-signed cert for PDS:

```(text)
Updating VS Code Server to version dc96b837cf6bb4af9cd736aa3af08cf8279f7685
Removing previous installation...
Installing VS Code Server for Linux x64 (dc96b837cf6bb4af9cd736aa3af08cf8279f7685)
Downloading: 100%
Failed
--2024-05-09 13:01:06--  https://update.code.visualstudio.com/commit:dc96b837cf6bb4af9cd736aa3af08cf8279f7685/server-linux-x64/stable
Resolving update.code.visualstudio.com (update.code.visualstudio.com)... 13.107.246.69, 13.107.213.69, 2620:1ec:bdf::69, ...
Connecting to update.code.visualstudio.com (update.code.visualstudio.com)|13.107.246.69|:443... connected.
ERROR: cannot verify update.code.visualstudio.com's certificate, issued by ‘emailAddress=certadmin@netskope.com,CN=ca.pacificdental.goskope.com,OU=e3d0cf1222e430abc0335ec532b67633,O=Pacific Dental Services,L=Irvine,ST=CA,C=US’:
  Self-signed certificate encountered.
To connect to update.code.visualstudio.com insecurely, use `--no-check-certificate'.
ERROR: Failed to download https://update.code.visualstudio.com/commit:dc96b837cf6bb4af9cd736aa3af08cf8279f7685/server-linux-x64/stable to /home/pan/.vscode-server/bin/dc96b837cf6bb4af9cd736aa3af08cf8279f7685-1715284866.tar.gz
Please install missing certificates.
Debian/Ubuntu:  sudo apt-get install ca-certificates
```

(I've tried that last command and some others but so far haven't succeeded.)

I'm thinking maybe I should explicitly add the PDS certificate (PEM file) with
an environment variable as suggested in this solution:
<https://stackoverflow.com/a/69758289>

But I'd like some perspective from a Help Desk wizard. Can you help me?

## References

* <https://docs.netskope.com/en/netskope-help/data-security/netskope-secure-web-gateway/configuring-cli-based-tools-and-development-frameworks-to-work-with-netskope-ssl-interception/>
* <https://stackoverflow.com/a/69758289>
* <https://nodejs.org/api/cli.html#node_extra_ca_certsfile>
* <https://ling123labs.com/posts/WSL-files-in-Windows-and-vice-versa/>
